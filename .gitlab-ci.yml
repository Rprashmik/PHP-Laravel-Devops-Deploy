image: docker:24

services:
  - docker:24-dind

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  DOCKER_BUILDKIT: 1

default:
  tags:
    - PHP-laravel

stages:
  - test
  - deploy

# --------------------
# TEST STAGE
# --------------------
test:
  stage: test
  script:
    # Start containers
    - docker compose up -d

    # WAIT for MySQL (CRITICAL FIX)
    - |
      echo "Waiting for MySQL..."
      for i in {1..20}; do
        if docker compose exec -T mysql mysqladmin ping -h "localhost" --silent; then
          echo "MySQL is ready"
          break
        fi
        echo "MySQL not ready yet..."
        sleep 3
      done

    # Clear Laravel cache
    - docker compose exec -T app php artisan config:clear
    - docker compose exec -T app php artisan cache:clear

    # Run migrations
    - docker compose exec -T app php artisan migrate --force

    # Run tests
    - docker compose exec -T app php artisan test

  after_script:
    - docker compose down -v || true

# --------------------
# DEPLOY STAGE
# --------------------
deploy:
  stage: deploy
  only:
    - main
  script:
    - docker compose -f docker-compose.prod.yml down || true
    - docker compose -f docker-compose.prod.yml up -d --build

    # Wait for MySQL in PROD
    - |
      echo "Waiting for PROD MySQL..."
      for i in {1..20}; do
        if docker compose -f docker-compose.prod.yml exec -T mysql mysqladmin ping -h "localhost" --silent; then
          echo "MySQL is ready"
          break
        fi
        sleep 3
      done

    - docker compose -f docker-compose.prod.yml exec -T app php artisan migrate --force
    - docker compose -f docker-compose.prod.yml exec -T app php artisan optimize
