stages:
  - install
  - test
  - deploy

variables:
  APP_ENV: "production"
  DB_CONNECTION: "mysql"
  DB_HOST: "127.0.0.1"
  DB_PORT: "3306"
  DB_DATABASE: "practical_app_db"
  DB_USERNAME: "root"
  DB_PASSWORD: "your_mysql_password"

before_script:
  - echo "Checking PHP version..."
  - php -v
  - echo "Checking Composer..."
  - composer --version || curl -sS https://getcomposer.org/installer | php && sudo mv composer.phar /usr/local/bin/composer
  - echo "Setting permissions..."
  - chmod -R 775 storage bootstrap/cache
  - chown -R $USER:www-data storage bootstrap/cache
  - cp .env.example .env || echo ".env already exists"
  - php artisan key:generate || echo "Key already generated"

install_dependencies:
  stage: install
  script:
    - echo "Installing Composer dependencies..."
    - composer install --no-interaction --prefer-dist
  artifacts:
    paths:
      - vendor/

run_tests:
  stage: test
  script:
    - echo "Running Laravel tests..."
    - php artisan test || echo "Tests completed with warnings"

deploy:
  stage: deploy
  script:
    - echo "Deploy step: Running migrations and clearing cache..."
    - php artisan migrate --force
    - php artisan config:cache
    - php artisan route:cache
    - php artisan view:cache
    - echo "Deployment completed!"
